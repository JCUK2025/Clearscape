<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transaction History – ClearScape Tracker</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>📜 Transaction History</h1>

  <!-- Filter Controls -->
  <div id="filters">
    <label>Type:
      <select id="filterType">
        <option value="">All</option>
        <option>Landscaping</option>
        <option>Lawn Maintenance</option>
        <option>Hedge trimming/Care</option>
        <option>Tree Surgery/Felling</option>
        <option>Fencing</option>
        <option>Contract work</option>
        <option>Other</option>
        <option>Fuel</option>
        <option>Wages</option>
        <option>Utilities</option>
        <option>Insurance</option>
        <option>Rent</option>
        <option>Materials</option>
        <option>Equipment</option>
        <option>Deposit</option>
      </select>
    </label>
    <label>Date:
      <input type="month" id="filterDate">
    </label>
    <label>Sort:
      <select id="sortOrder">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
      </select>
    </label>
    <button onclick="applyFilters()">🔍 Apply Filters</button>
    <button onclick="clearFilters()">❌ Clear</button>
  </div>

  <!-- Scrollable Transaction List -->
  <div id="transactionScroll">
    <div id="transactionList"></div>
  </div>

  <!-- Navigation -->
  <div id="navButtons">
    <button onclick="location.href='index.html?skipSplash=true'" class="nav-button">🏠 Back to Dashboard</button>
    <button onclick="exportCSV()" class="nav-button">📁 Export to CSV</button>
  </div>

  <!-- Motivational Footer -->
  <footer>
    <p>🌱 Keep growing — every transaction brings clarity and progress.</p>
  </footer>

  <script>
    let transactions = JSON.parse(localStorage.getItem("transactions")) || [];

    function renderHistory(filtered = transactions) {
      const list = document.getElementById("transactionList");
      list.innerHTML = "";

      filtered.slice(0, 8).forEach((t, i) => {
        const outstanding = t.totalDue - t.amountPaid;
        const isOutstanding = outstanding > 0;

        const container = document.createElement("div");
        container.className = "swipe-container";

        const card = document.createElement("div");
        card.className = "transaction-card";
        card.innerHTML = `
          🗓️ ${t.date} | 💰 ${t.type} | 👤 ${t.name || "—"} | £${t.amountPaid.toFixed(2)} paid
          ${isOutstanding ? `<span style="color:red;">| £${outstanding.toFixed(2)} outstanding</span>` : `| £0.00 outstanding`}
          | 💳 ${t.paymentMethod}
          <br>📝 ${t.notes}
          ${t.recurring !== "None" ? `<br>🔁 ${t.recurring}` : ""}
        `;

        const actions = document.createElement("div");
        actions.className = "swipe-actions";
        actions.innerHTML = `
          <button onclick="editTransaction(${i})">✏️ Edit</button>
          ${isOutstanding ? `<button onclick="repayTransaction(${i})">💸 Repay</button>` : ""}
          <button onclick="deleteTransaction(${i})">🗑️ Delete</button>
        `;

        container.appendChild(card);
        container.appendChild(actions);
        list.appendChild(container);
      });

      enableSwipeGestures();
    }

    function enableSwipeGestures() {
      const containers = document.querySelectorAll(".swipe-container");

      containers.forEach(container => {
        let startX = 0;

        container.addEventListener("touchstart", e => {
          startX = e.touches[0].clientX;
        });

        container.addEventListener("touchend", e => {
          const endX = e.changedTouches[0].clientX;
          const deltaX = endX - startX;

          if (deltaX < -50) {
            container.classList.add("show-actions");
          } else if (deltaX > 50) {
            container.classList.remove("show-actions");
          }
        });
      });
    }

    function applyFilters() {
      const type = document.getElementById("filterType").value;
      const date = document.getElementById("filterDate").value;
      const sortOrder = document.getElementById("sortOrder").value;

      let filtered = transactions.filter(t => {
        const matchType = type ? t.type === type : true;
        const matchDate = date ? t.date.startsWith(date) : true;
        return matchType && matchDate;
      });

      if (sortOrder === "newest") {
        filtered.reverse();
      }

      renderHistory(filtered);
    }

    function clearFilters() {
      document.getElementById("filterType").value = "";
      document.getElementById("filterDate").value = "";
      document.getElementById("sortOrder").value = "newest";
      renderHistory();
    }

    function editTransaction(index) {
      location.href = `index.html?edit=${index}`;
    }

    function deleteTransaction(index) {
      if (confirm("Are you sure you want to delete this transaction?")) {
        transactions.splice(index, 1);
        localStorage.setItem("transactions", JSON.stringify(transactions));
        renderHistory();
      }
    }

    function repayTransaction(index) {
      const t = transactions[index];
      const remaining = t.totalDue - t.amountPaid;
      const amount = prompt(`Enter repayment amount for ${t.name} (max £${remaining.toFixed(2)}):`, remaining.toFixed(2));
      const value = parseFloat(amount);

      if (!isNaN(value) && value > 0 && value <= remaining) {
        t.amountPaid += value;
        localStorage.setItem("transactions", JSON.stringify(transactions));
        renderHistory();
      } else {
        alert("Invalid repayment amount.");
      }
    }

    function exportCSV() {
      const headers = [
        "Date", "Type", "Name", "Notes", "Total Due",
        "Amount Paid", "Payment Method", "Recurring"
      ];

      const rows = transactions.map(t => [
        t.date, t.type, t.name, t.notes, t.totalDue,
        t.amountPaid, t.paymentMethod, t.recurring
      ]);

      const csvContent = [headers, ...rows]
        .map(row => row.map(value => `"${String(value).replace(/"/g, '""')}"`).join(","))
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "clearscape-transactions.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderHistory();
    });
  </script>
</body>
</html>




