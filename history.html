<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transaction History â€“ ClearScape Tracker</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ğŸ“œ Transaction History</h1>

  <!-- Filter Controls -->
  <div id="filters">
    <label>Type:
      <select id="filterType">
        <option value="">All</option>
        <option value="Sale">Sale</option>
        <option value="Expense">Expense</option>
        <option value="Deposit">Deposit</option>
      </select>
    </label>
    <label>Category:
      <select id="filterCategory">
        <option value="">All</option>
        <option>Landscaping</option>
        <option>Consulting</option>
        <option>Fuel</option>
        <option>Supplies</option>
        <option>Other</option>
        <option>Deposit</option>
      </select>
    </label>
    <label>Date:
      <input type="month" id="filterDate">
    </label>
    <label>Sort:
      <select id="sortOrder">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
      </select>
    </label>
    <button onclick="applyFilters()">ğŸ” Apply Filters</button>
    <button onclick="clearFilters()">âŒ Clear</button>
  </div>

  <!-- Transaction List -->
  <div id="transactionList"></div>

  <!-- Navigation -->
  <div id="navButtons">
    <button onclick="location.href='index.html?skipSplash=true'" class="nav-button">ğŸ  Back to Dashboard</button>
    <button onclick="exportCSV()" class="nav-button">ğŸ“ Export to CSV</button>
  </div>

  <!-- Motivational Footer -->
  <footer>
    <p>ğŸŒ± Keep growing â€” every transaction brings clarity and progress.</p>
  </footer>

  <script>
    let transactions = JSON.parse(localStorage.getItem("transactions")) || [];

    function renderHistory(filtered = transactions) {
      const list = document.getElementById("transactionList");
      list.innerHTML = "";

      filtered.forEach((t, i) => {
        const div = document.createElement("div");
        const outstanding = t.totalDue - t.amountPaid;
        const isOutstanding = outstanding > 0;

        div.innerHTML = `
          ğŸ—“ï¸ ${t.date} | ğŸ’° ${t.type} | ğŸ§¾ ${t.category} | ğŸ‘¤ ${t.name || "â€”"} | Â£${t.amountPaid.toFixed(2)} paid
          ${isOutstanding ? `<span style="color:red;">| Â£${outstanding.toFixed(2)} outstanding</span>` : `| Â£0.00 outstanding`}
          | ğŸ’³ ${t.paymentMethod}
          <br>ğŸ“ ${t.notes}
          ${t.recurring !== "None" ? `<br>ğŸ” ${t.recurring} â†’ Next: ${t.repeatDate}` : ""}
          <br>
          <button onclick="editTransaction(${i})">âœï¸ Edit</button>
          <button onclick="deleteTransaction(${i})">ğŸ—‘ï¸ Delete</button>
          ${isOutstanding ? `<button onclick="repayTransaction(${i})">ğŸ’¸ Repay</button>` : ""}
        `;
        list.appendChild(div);
      });
    }

    function applyFilters() {
      const type = document.getElementById("filterType").value;
      const category = document.getElementById("filterCategory").value;
      const date = document.getElementById("filterDate").value;
      const sortOrder = document.getElementById("sortOrder").value;

      let filtered = transactions.filter(t => {
        const matchType = type ? t.type === type : true;
        const matchCategory = category ? t.category === category : true;
        const matchDate = date ? t.date.startsWith(date) : true;
        return matchType && matchCategory && matchDate;
      });

      if (sortOrder === "newest") {
        filtered.reverse();
      }

      renderHistory(filtered);
    }

    function clearFilters() {
      document.getElementById("filterType").value = "";
      document.getElementById("filterCategory").value = "";
      document.getElementById("filterDate").value = "";
      document.getElementById("sortOrder").value = "newest";
      renderHistory();
    }

    function editTransaction(index) {
      location.href = `index.html?edit=${index}`;
    }

    function deleteTransaction(index) {
      if (confirm("Are you sure you want to delete this transaction?")) {
        transactions.splice(index, 1);
        localStorage.setItem("transactions", JSON.stringify(transactions));
        renderHistory();
      }
    }

    function repayTransaction(index) {
      const t = transactions[index];
      const remaining = t.totalDue - t.amountPaid;
      const amount = prompt(`Enter repayment amount for ${t.name} (max Â£${remaining.toFixed(2)}):`, remaining.toFixed(2));
      const value = parseFloat(amount);

      if (!isNaN(value) && value > 0 && value <= remaining) {
        t.amountPaid += value;
        localStorage.setItem("transactions", JSON.stringify(transactions));
        renderHistory();
      } else {
        alert("Invalid repayment amount.");
      }
    }

    function exportCSV() {
      const headers = [
        "Date", "Type", "Name", "Notes", "Category",
        "Total Due", "Amount Paid", "Payment Method",
        "Recurring", "Next Repeat Date"
      ];

      const rows = transactions.map(t => [
        t.date, t.type, t.name, t.notes, t.category,
        t.totalDue, t.amountPaid, t.paymentMethod,
        t.recurring, t.repeatDate
      ]);

      const csvContent = [headers, ...rows]
        .map(row => row.map(value => `"${String(value).replace(/"/g, '""')}"`).join(","))
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "clearscape-transactions.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderHistory();
    });
  </script>
</body>
</html>



