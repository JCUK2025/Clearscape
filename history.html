<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ClearScape History</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <!-- Splash Screen -->
  <div id="splash" style="display:none;">
    <img id="logo" src="logo.png" alt="ClearScape Logo">
    <button onclick="enterApp()">ClearScape</button>
  </div>

  <h1>ğŸ“œ Transaction History</h1>
  <p id="historyQuote" style="font-style: italic; color: #2e5d2e; text-align: center;"></p>

  <form id="filterForm" onsubmit="applyFilters(); return false;">
    <label>Date From:
      <input type="date" id="dateFrom" class="filter-input">
    </label>

    <label>Date To:
      <input type="date" id="dateTo" class="filter-input">
    </label>

    <label>Type:
      <select id="filterType" class="filter-input">
        <option value="">All</option>
        <option>Sale</option>
        <option>Expense</option>
        <option>Deposit</option>
        <option>Refund</option>
      </select>
    </label>

    <label>Search Name:
      <input type="text" id="filterName" class="filter-input" placeholder="Client or job name">
    </label>

    <div id="filterButtons">
      <button type="submit" class="nav-button">ğŸ¯ Apply Filters</button>
      <button type="button" class="nav-button" onclick="clearFilters()">ğŸ§¹ Clear</button>
      <button type="button" class="nav-button" onclick="downloadCSV()">ğŸ“ Download CSV</button>
      <button type="button" class="nav-button" onclick="downloadAllCSV()">ğŸ“‚ Download All CSV</button>
    </div>
  </form>

  <section id="historyScroll">
    <div id="historyResults"></div>
  </section>

  <script>
    function updateHistoryQuote() {
      const quoteBox = document.getElementById("historyQuote");
      const quotes = [
        "ğŸ’¼ Success is built on small, consistent entries.",
        "ğŸ“Š What gets measured gets managed.",
        "ğŸ§  Clear records lead to clear decisions.",
        "ğŸ“† History is your business memory.",
        "ğŸ” Filtered facts lead to focused action.",
        "ğŸƒ Octoberâ€™s here â€” carve out clarity.",
        "ğŸ„ Log it before the lights go up!",
        "ğŸŒ¸ Spring into tidy records.",
        "ğŸ† Fireworks fade, but good data lasts.",
        "ğŸ£ Hatch new habits this Easter.",
        "ğŸ§¾ Logging transactions: cheaper than therapy.",
        "ğŸ“š Your future self says thanks for this entry.",
        "ğŸª´ Small jobs, big insights.",
        "ğŸ’¬ Notes today, fewer headaches tomorrow.",
        "ğŸ“ˆ Logging: the only habit that pays you back."
      ];
      const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
      quoteBox.textContent = randomQuote;
    }

    let inactivityTimer;

    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        const splash = document.getElementById("splash");
        if (splash) {
          splash.style.display = "flex";
          splash.style.opacity = "1";
        }
      }, 300000); // 5 minutes
    }

    ["click", "mousemove", "keydown", "touchstart"].forEach(event =>
      document.addEventListener(event, resetInactivityTimer)
    );

    function enterApp() {
      const splash = document.getElementById("splash");
      if (splash) {
        splash.style.opacity = "0";
        setTimeout(() => {
          splash.style.display = "none";
        }, 1000);
      }
    }

    function applyFilters() {
      const from = document.getElementById("dateFrom").value;
      const to = document.getElementById("dateTo").value;
      const type = document.getElementById("filterType").value;
      const name = document.getElementById("filterName").value.toLowerCase();

      const results = document.getElementById("historyResults");
      results.innerHTML = "";

      const transactions = JSON.parse(localStorage.getItem("transactions")) || [];

      const filtered = transactions.filter(t => {
        const matchDate =
          (!from || t.date >= from) &&
          (!to || t.date <= to);
        const matchType = !type || t.type === type;
        const matchName = !name || t.name.toLowerCase().includes(name);
        return matchDate && matchType && matchName;
      });

      if (filtered.length === 0) {
        results.innerHTML = "<p>No matching transactions found.</p>";
        return;
      }

      filtered.forEach(t => {
        const card = document.createElement("div");
        card.className = "transaction-card";
        if (t.type === "Refund") {
          card.classList.add("refund-card");
        }

        card.innerHTML = `
          <p><strong>${t.type}</strong> â€” ${t.category}</p>
          <p>Client: ${t.name}</p>
          <p>Date: ${t.date}</p>
          <p>Amount Paid: Â£${t.amountPaid.toFixed(2)}</p>
          <p>Total Due: Â£${t.totalDue.toFixed(2)}</p>
          <p>Method: ${t.paymentMethod}</p>
          <p>Recurring: ${t.recurring}</p>
          <p>Notes: ${t.notes || "None"}</p>
        `;

        results.appendChild(card);
      });
    }

    function clearFilters() {
      document.getElementById("dateFrom").value = "";
      document.getElementById("dateTo").value = "";
      document.getElementById("filterType").value = "";
      document.getElementById("filterName").value = "";
      applyFilters();
    }

    function downloadCSV() {
      const from = document.getElementById("dateFrom").value;
      const to = document.getElementById("dateTo").value;
      const type = document.getElementById("filterType").value;
      const name = document.getElementById("filterName").value.toLowerCase();

      const transactions = JSON.parse(localStorage.getItem("transactions")) || [];

      const filtered = transactions.filter(t => {
        const matchDate =
          (!from || t.date >= from) &&
          (!to || t.date <= to);
        const matchType = !type || t.type === type;
        const matchName = !name || t.name.toLowerCase().includes(name);
        return matchDate && matchType && matchName;
      });

      if (filtered.length === 0) {
        alert("No transactions to export.");
        return;
      }

      const headers = ["Date", "Type", "Name", "Category", "Notes", "Total Due", "Amount Paid", "Method", "Recurring"];
      const rows = filtered.map(t => [
        t.date,
        t.type,
        t.name,
        t.category,
        `"${t.notes || ""}"`,
        t.totalDue.toFixed(2),
        t.amountPaid.toFixed(2),
        t.paymentMethod,
        t.recurring
      ]);

      const csvContent = [headers, ...rows]
        .map(row => row.join(","))
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "clearscape-history.csv";
      link.click();
    }

    function downloadAllCSV() {
      const transactions = JSON.parse(localStorage.getItem("transactions")) || [];

      if (transactions.length === 0) {
        alert("No transactions to export.");
        return;
      }

      const headers = ["Date", "Type", "Name", "Category", "Notes", "Total Due", "Amount Paid", "Method", "Recurring"];
      const rows = transactions.map(t => [
        t.date,
        t.type,
        t.name,
        t.category,
        `"${t.notes || ""}"`,
        t.totalDue.toFixed(2),
        t.amountPaid.toFixed(2),
        t.paymentMethod,
        t.recurring
      ]);

      const csvContent = [headers, ...rows]
        .map(row => row.join(","))
        .join("\n


